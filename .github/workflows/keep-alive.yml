name: Keep Streamlit App Alive

on:
  schedule:
    # Runs twice daily at 8:00 UTC and 20:00 UTC
    - cron: '0 8 * * *'
    - cron: '0 20 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium

      - name: Wake up Streamlit App
        run: |
          node << 'EOF'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();

            console.log('Navigating to Streamlit app...');
            await page.goto(process.env.STREAMLIT_APP_URL, { waitUntil: 'networkidle', timeout: 60000 });

            // Check if app is sleeping and needs to be woken up
            const wakeButton = await page.$('button:has-text("Yes, get this app back up")');
            if (wakeButton) {
              console.log('App is sleeping, clicking wake-up button...');
              await wakeButton.click();
              // Wait for app to fully load after waking
              await page.waitForTimeout(30000);
              console.log('App has been woken up!');
            } else {
              console.log('App is already awake!');
            }

            await browser.close();
            console.log('Done!');
          })();
          EOF
        env:
          STREAMLIT_APP_URL: ${{ secrets.STREAMLIT_APP_URL }}
